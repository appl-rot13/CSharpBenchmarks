name: Build/Test

on:
  push:
    branches: [ main ]

jobs:
  find-solutions:
    runs-on: ubuntu-latest
    outputs:
      solutions: ${{ steps.find-solutions.outputs.solutions }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Find solutions
      id: find-solutions
      run: |
        solutions_as_json=$(find . -type f -name "*.sln" | jq -R -s -c 'split("\n")[:-1]')
        echo "solutions=${solutions_as_json}" >> "${GITHUB_OUTPUT}"

  build-and-test:
    runs-on: windows-latest
    needs: find-solutions
    strategy:
      fail-fast: false
      matrix:
        solution: ${{ fromJSON(needs.find-solutions.outputs.solutions) }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore ${{ matrix.solution }}

    - name: Build
      run: dotnet build ${{ matrix.solution }} --no-restore

    - name: Test
      run: dotnet test ${{ matrix.solution }} --no-build --verbosity normal
